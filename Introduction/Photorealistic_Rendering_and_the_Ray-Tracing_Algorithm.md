# 真实感渲染和光线追踪算法

真实感渲染的目标是生成一个与相同3D场景照片无法区分的图像。不过在我们描述渲染之前需要知道，这里使用的“无法区分”这个词是不准确的，因为它涉及人类观察者，不同的观察者也许会以不同的方式感知同一幅图像。尽管我们将在本书中介绍一些感性问题，但考虑到给定观察者的确切特征是一个非常困难且基本上无法解决的问题。在大多数情况下，我们通常局限于对光的物理及其与物质的相互作用的精确模拟，依靠我们对显示技术的理解，向观众展示最佳图像。

几实乎所有的真感渲染系统都基于光线追踪算法。光线追踪实际上是一种非常简单的算法：它基于在场景中与对象交互和反弹时，通过场景的光线路径。尽管有许多方法可以编写光线追踪渲染器，但所有这些系统至少会模拟以下对象和现象：

* 相机：摄像机模型确定查看场景的方式和位置，包括如何记录场景图像。许多渲染系统从摄像机开始生成查看光线，然后跟踪到场景中。
* 光线对象求交：我们必须能够准确地判断给定光线与给定几何物体相交的位置。此外，我们需要确定对象在交点处的某些属性，如曲面法线或其材质。大多数光线追踪器还具有一些用于测试具有多个对象的光线交集的设施，通常返回沿射线的最接近的交点。
* 光源：如果没有照明，渲染场景就没有什么点了。光线追踪器必须模拟整个场景中的光分布，不仅包括灯光本身的位置，还包括它们在整个空间中分配能量的方式。
* 可见性：为了知道给定的光是否在表面上的一个点上沉积能量，我们必须知道是否有从点到光源的不间断路径。幸运的是，这个问题在光线追踪器中很容易回答，因为我们只需构造光线从表面到光线，找到最接近的光线对象交集，并比较与光距离的交点距离。
* 表面散射：每个对象必须提供其外观的描述，包括有关光如何与物体表面相互作用的信息，以及重新拉（或散射）光的性质。表面散射模型通常进行参数化，以便它们可以模拟各种外观。
* 间接光传输：由于光线在弹跳或穿过其他表面后可能到达曲面，因此通常需要跟踪源自曲面的其他光线，以完全捕获此效果。
* 光线传播：我们需要知道光线穿过太空时，沿着光线的传递会发生什么。如果我们在真空中渲染场景，光能沿光线保持不变。虽然真正的真空在地球上是不寻常的，但是对于许多环境来说，它们是一个合理的近似值。更复杂的模型可用于通过雾、烟雾、地球大气层等跟踪光线。

我们将在本节中简要讨论这些模拟任务。下一节中，我们将向基础仿真组件显示pbrt的高级别接口，并跟踪单个光线在主渲染循环中的进度。我们还将介绍基于Turner Whitted的原始光线追踪算法的表面散射模型的实现。

## 相机
几乎每个人都使用过相机，并熟悉其基本功能：您表示您想要录制世界图像（通常通过按下按钮或点击屏幕），并且图像被记录在一张胶片或电子传感器上。最简单的拍照装置之一叫做针孔相机。针孔摄像机由一端有一个小孔的光密盒组成（图1.1）。当孔被揭开时，光线进入这个孔，落在贴在盒子另一端的一张摄影纸上。尽管它简单，这种相机仍然使用今天，经常为艺术目的。需要很长的曝光时间，以获得足够的光线在胶片上形成图像。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Pinhole%20Camera.svg">图1.1：针孔摄像机。</img>

尽管大多数摄像机比针孔摄像机复杂得多，但它是模拟的方便起点。摄像机最重要的功能是定义将录制到胶片上的场景部分。在图 1.1中，我们可以看到将针孔连接到胶片边缘如何创建一个延伸至场景的双金字塔。无法将不在此金字塔内的对象成像到胶片上。由于实际摄像机的图像形状比金字塔复杂，因此我们将引用可能作为观看量在胶片上成像的空间区域。

另一种考虑针孔相机的方法是将胶片平面放在针孔前面，但距离相同（图1.2）。请注意，将孔连接到胶片定义与以前完全相同的观看音量。当然，这不是构建真实相机的实用方法，但出于仿真目的，它是一种方便的抽象。当薄膜（或图像）平面位于针孔前面时，针孔通常被称为"眼睛"。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Film%20in%20front.svg">图1.2：当我们模拟针孔相机时，我们把胶片放在靠近平面的孔前面，孔改名为眼睛。</img>

现在我们来讨论渲染的关键问题：在图像的每个点，相机会记录什么颜色值？如果我们回想起原始的针孔相机，很明显，只有沿着针孔和胶片上的一个点之间的矢量传播光线才能对胶片位置造成帮助。在我们的模拟相机与胶片平面在眼睛前，我们感兴趣的光量从图像点到眼睛。

因此，相机模拟器的一个重要任务是在图像上采取一个点，并生成光线，使射点光线有助于该图像位置。由于光线由原点和方向矢量组成，因此此任务对于图 1.2的针孔摄像机模型来说特别简单：它使用来自针孔的针孔以及从针孔到近平面的矢量作为光线的方向。对于涉及多个镜头的更复杂的相机模型，可能更需要计算与图像上给定点对应的光线。（第 6.4节描述了此类模型的实现。

通过将图像位置转换为完全封装在摄像机模块中的光线的过程，渲染系统的其余部分可以专注于评估这些光线的照明，并且可以支持各种摄像机模型。pbrt的相机抽象在第6章中详细描述。

## 光线与对象求交

每次摄像机生成光线时，渲染器的首要任务是确定哪个对象（如果有）首先与哪个对象相交以及交集发生的位置。此交点是沿光线的可见点，此时我们将要模拟光与对象的交互。要查找交点，我们必须测试场景中所有对象的交集的光线，并选择光线首先相交的对象。给定一个$r$，我们首先以参数化形式编写它：

$$r(t) = o + t \pmb d.$$

其中线$o$是光线的原点，粗体$\pmb d$是其方向向是一个参数，其中$t$ $(0, \infty)$。我们可以通过指定其参数$t$值并计算上述方程沿射线的点。

通常很容易找到光线法线 r 和隐式函数定义的曲面之间的交集 F 左括号。我们首先将射线方程替换为隐式方程，产生一个唯一参数为t的新。然后，我们求解此并替换最小的正根到射线方程中，以找到所需的点。例如，以半径原点为中心的球体的隐式方程是：
$$x^2 + y^2 + z^2 - r^2 = 0.$$
代入射线方程，我们有：

$$(o_x + t \pmb d_x)^2 + (o_y + t \pmb d_y)^2 + (o_z + t \pmb d_z)^2 - r^2 = 0.$$

除了 $t$ 之外都是已知的，方程给我们一个容易解的二次 $t$ 。如果没有实根，射线会漏过球体。如果有根，最小的正根给出交点。

仅交点不足以用于光线追踪器的其余部分：它需要知道表面在点上的某些属性。首先，必须确定该点材料的表示形式，并传递到光线追踪算法的后期阶段。其次，还需要有关交点的其他几何信息才能遮蔽点。例如，始终需要曲面$\pmb n$法线。尽管许多光线追踪器仅使用$\pmb n$，但更复杂的渲染系统（如 pbrt）需要更多的信息，例如位置和曲面法线的各种部分导数和曲面法线与曲面的局部参数化有关。

当然，大多数场景由多个对象。蛮力方法是反过来测试每个对象的光线，选择所有交点的最小 $t$ 值以查找最接近的交点。这种方法虽然正确，但速度非常慢，即使对于复杂程度适中的场景。更好的方法是合并一个加速度结构，该结构在射线交点过程中快速拒绝整个对象组。这种快速剔除不相关几何体的能力意味着射线追踪经常会出现$O(I log N)$的时间，这里的$I$是图像的像素数并且$N$是场景中的物体数。（然而，构建加速结构本身必须至少是$O(N)$时间。）

pbrt的几何界面及其各种形状的实现在第3章中介绍，加速度界面和实现在第4章中展示。

## 光分配
光线与对象求交阶段为我们提供了要着色的点，以及有关该点局部几何体的一些信息。回想一下，我们的最终目标是找到在相机方向上留下此点的光量。为了做到这一点，我们需要知道有多少光到达这一点。这涉及场景中光线的几何和辐射分布。对于非常简单的光源（例如点光源），照明的几何分布是了解灯光位置的简单问题。但是，点光源在现实世界中并不存在，因此基于物理的照明通常基于区域光源。这意味着光源与从其表面发出照明的几何对象关联。但是，我们将使用本节中的点光源来说明光分布的成分;严格讨论光测量和分布是第5章和第12章的主题。

我们经常想知道在交点周围的差分区域沉积的光功率量（图1.3）。我们将假设点光源具有一些与$\Phi$，并且它在所有方向上均等地辐射光。这意味着光周围的单位球体上每个区域的功率是正常的$\frac{\Phi}{4\pi}$。（这些测量将在第5.4 节中解释和正式化 。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Basic%20reflection%20setting.svg">图 1.3：用于确定由于点光源而到达一个点的每个区域的功率的几何结构。从点到光源的距离用$r$。</img>

如果我们考虑两个这样的球体（图1.4），很明显，在较大球体上一个点的面积的功率必须小于小球体上一个点的功率，因为相同的总功率分布在较大的区域上。具体地说，到达半径区域$r$上的点每个区域的功率$\frac{1}{r^2}$。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Light%20spheres%20equal%20power.svg">图1.4：由于点光在所有方向均等地辐射光，因此相同的总功率沉积在以光为中心的所有球体上。</img>

此外，可以表明，如果微小的表面斑块$dA$倾斜的角度$\theta$表面点到光向量，则沉积在$d$上功率$A$与余弦$cos \theta$。综合起来，每个面积的微分功率$dE$（*微分辐照度*） 是

$$dE = \frac{\Phi cos \theta}{4 \pi r^2}.$$

已经熟悉计算机图形基本照明的读者会注意到这个方程中编码的两种熟悉的定律：上述倾斜表面$r$的余弦光的落体，以及具有距离的光的一比四的光的落体。

具有多个灯光的场景很容易处理，因为照明是*线性的*：每个灯光的贡献可以单独计算和汇总，以获得整体贡献。

## 可见性
上一节中描述的照明分布忽略了一个非常重要的组件：阴影。只有当从点到光的位置的路径畅通无阻时，每个光源才对点进行着色（图1.5）。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Two%20lights%20one%20blocker.svg">图 1.5：光源只有在从接收点看光源没有被遮挡的情况下才会在表面上沉积能量。左边的光源照亮这个点$p$，但是右边的光源没有。</img>

幸运的是，在光线追踪器中，很容易确定光线是否从着色点可见。我们只需构造一条新射线，其原点位于表面点，其方向指向光。这些特殊的光线被称为*阴影射线*。如果我们在环境中跟踪此光线，我们可以通过比较沿光源位置的光线找到的任何交集$t$来检查是否找到光线原点和光源之间的任何交点$t$。如果光和表面之间没有阻塞对象，则包括光的贡献。

## 表面散射
现在，我们能够计算两条信息，这些信息对于正确着色一个点至关重要：其位置和事件照明。†现在我们需要确定事件照明是如何分散在表面的。具体来说，我们对散落在光线上的光能量感兴趣，我们最初跟踪的光线会找到交点点，因为光线通向相机（图1.6）。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Surface%20scattering%20geometry.svg">图1.6：曲面散射的几何。事件光到达沿$\omega_i$与表面在点$p$和分散回相机沿方向$\omega_o$射向摄像机的光量由射点光能和 BRDF 的倍数提供。</img>

场景中的每个对象都提供一个材质，该材质描述其在曲面上每个点上的外观属性。此描述由*双向反射分布函数*（BRDF） 给出。这个函数告诉我们有多少能量从传入方向$\omega_i$反射到传出方向$\omega_o$。我们将BRDF写成在$p$的$f_r(p, \omega_o, \omega_i)$。现在，计算散射到相机光量非常简单：
```
对每一个 光源：
    如果 光源 没有被阻挡：
        入射光 = 光源射向碰撞点的亮度
        反射系数 = 表面的BRDF(碰撞点, 相机方向, 光源方向);
        光照 += 反射系数 * 入射光
```
在这里，我们使用符号$L$来表示光;这表示光测量的单位与之前使用的$dE$单位略有不同。

将 BRDF 的概念概括为透射光（获取 BTDF）或从表面两侧到达的光的一般散射很容易。描述一般散射的函数称为*双向散射分布函数*（BSDF）。pbrt支持各种 BSDF 型号;它们在第8章中描述。更为复杂的是*双向散射表面反射分布函数*（BSSRDF），该函数对在与进入不同点处退出曲面的光进行模型。BSSRDF 在第5.6.2、11.4和15.5 节中描述。

## 间接光传输
Turner Whitted关于光线追踪的原始论文（1980年）强调了其递归性，这是使间接镜面反射和渲染图像传输成为可能的关键。例如，如果来自相机的光线像镜子一样击中闪亮的物体，我们可以在交点处反射有关表面法线的光线，并递归地调用光线追踪例程来查找到达镜像点上的光线，从而将其贡献添加到原始摄像机光线中。这种技术可用于跟踪与透明对象相交的传输光线。长期以来，大多数早期的光线追踪示例都展示了镜子和玻璃球（图1.7），因为这些类型的效果很难用其他渲染技术捕捉。

![Whitted光线追踪](https://www.pbr-book.org/3ed-2018/Introduction/spheres-whitted.png)
![随机渐进光子映射](https://www.pbr-book.org/3ed-2018/Introduction/spheres-sppm.png)
图 1.7：原型早期光线追踪场景。请注意使用镜像对象和玻璃对象，这强调了算法处理这些类型的曲面的能力。（1） 使用Whitted光线追踪进行渲染，（2）使用随机逐行光子映射 （SPPM） 渲染 ， 这是一种高级光传输算法，将在第 16.2 节中引入。SPPM 能够精确模拟穿过球体的焦散。

通常，从物体上某个点到达相机的光量由物体（如果它本身是光源）发出的光与反射光量之和给出。 这个想法由*光传输方程*（也通常称为*渲染方程*）给出，该方程式表示从某个方向上的点发出的辐射$L_o(p, \omega_o)$是该$\omega_o$方向上该点$p$处的发射辐射$L_e(p, \omega_o)$，加上$p$周围球面$S^2$上来自各个方向的入射辐射率以BSDF和余弦项进行换算：

$$L_o(p, \omega_o) = L_e(p, \omega_o) + \int_{S^2}f(p, \omega_o, \omega_i)L_i(p, \omega_i)|cos \theta_i|d\omega_i.$$ (1.1)

我们将在第5.6.1节和14.4节中显示此方程的更完整的推导。除了最简单的场景之外，不可能以解析方式求解这种积分，因此我们必须做出简化的假设或使用数值积分技术。

Whitted 的算法简化了这一积分，它忽略了来自大多数方向的传入光，并且只评估$L_i(p, \omega_i)$方向到光源以及完全反射和折射的方向。换句话说，它将积分转换为少数方向的总和。

Whitted的方法可以扩展，以捕捉更多的效果，而不仅仅是完美的镜子和玻璃。例如，通过跟踪镜像反射方向附近的许多递归光线并平均其贡献，我们获得光泽反射的近似值。事实上，每当我们击中对象时，我们始终可以递归地跟踪光线。例如，我们可以随机选择一个反射方向$\omega_i$，并通过评估BRDF$f_r(p, \omega_o, \omega_i)$来加权这个新生成的射线的贡献。这个简单而强大的想法可以导致非常逼真的图像，因为它捕获了物体之间的所有光线反射。当然，我们需要知道何时终止递归，完全随机选择方向会使渲染算法缓慢收敛到合理的结果。但是，这些问题是可以解决的;这些问题是第13至16章的主题。

当我们以这种方式递归地跟踪光线时，我们确实将*光线树*与每个图像位置（图1.8）与来自摄像机的光线与树根处的光线关联。此树中的每一条射线都可以具有与之关联的权重;这允许我们建模，例如，不反映100%的入射光的闪亮表面。

<img src="https://www.pbr-book.org/3ed-2018/Introduction/Ray%20Tree.svg">图 1.8：递归光线追踪将整个光线树与每个图像位置关联</img>

## 光线传播
到目前为止的讨论假定光线正在真空中传播。例如，在描述来自点光源的光分布时，我们假设光的功率在以光为中心的球体表面上均等分布，而不会沿途减小。参与媒体（如*烟*、*雾*或*0灰尘*）的存在可能会使这一假设无效。这些效果对于模拟非常重要：即使我们不渲染充满烟雾的房间，几乎所有室外场景都受到参与媒体的严重影响。例如，地球大气层使距离较远的物体看起来饱和度较低（图1.9）。

![无大气散射](https://www.pbr-book.org/3ed-2018/Introduction/ecosys-nofog.png)
![带大气散射](https://www.pbr-book.org/3ed-2018/Introduction/ecosys-fog.png)
图1.9：地球大气随距离而降低饱和度。（1） 渲染场景时不模拟这种现象，而 （2） 包含大气模型。这种大气衰减是查看真实场景时的重要深度提示，为第二次渲染添加了比例感。

参与介质有两种方式可以影响沿射线传播的光线。首先，介质可以通过吸收或分散在不同的方向来熄灭（或衰减）光。我们可以通过计算射线原点和*交点*$T$来捕获此效果。透射性告诉我们在交点散射的光有多少会回到光线原点。

参与介质还可以沿光线向光线添加光线。如果介质发出光（如火焰），或者介质沿光线从其他方向散射光（图1.10），就会发生这种情况。我们可以通过数值计算体积光传输方程来找到这个数量，就像我们评估光传输方程来查找从表面反射的光量一样。我们将把参与媒体和卷呈现的描述留到第11章和第15章。现在，只要说我们可以计算参与媒体的效果，并将其效果融入光线携带的光量中就够了。

![透过雾聚焦在球上](https://www.pbr-book.org/3ed-2018/Introduction/spotfog.png)
图1.10：透过雾聚焦在球上。请注意，由于参与介质中的额外散射，聚光灯的照明分布形状和球体的阴影清晰可见。
